<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>탱탱볼 터뜨리기 게임</title>
  <style>
    body { background: #222; margin: 0; }
    canvas { display: block; margin: 0 auto; background: #eee; }
    #info { color: #fff; text-align: center; margin: 10px; }
    #restart { display: none; margin: 0 auto; }
  </style>
</head>
<body>
  <div id="info">
    ← → : 이동 &nbsp; | &nbsp; 총알은 자동 발사<br>
    <button id="restart" onclick="restartGame()">다시 시작</button>
  </div>
  <canvas id="game" width="480" height="640"></canvas>
  <script>
    // 상수
    const GRAVITY = 0.5;
    const BOUNCE_LOSS = 0.95;
    const BALL_MIN_RADIUS = 16;
    const BALL_MAX_RADIUS = 40;
    const BALL_MIN_SPLIT = 2;
    const BALL_MAX_SPLIT = 4;
    const BULLET_INTERVAL = 100;
    const BALL_SPAWN_INTERVAL = 2000;

    // 캔버스
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // 플레이어
    const player = { x: 240, y: 600, w: 40, h: 20, speed: 5 };

    // 게임 변수
    let bullets = [];
    let balls = [];
    let keys = {};
    let gameOver = false;
    let score = 0;
    let lastBulletTime = 0;
    let lastBallTime = 0;

    // 세트 관리
    let setNumber = 1; // 현재 세트(라운드)
    let bulletRows = 1; // 총알 줄 수 (1,2,3,...)
    let ballsInSet = 0; // 현재 세트의 전체 공 개수
    let ballsDestroyedInSet = 0; // 현재 세트에서 부순 공 개수

    // 공 생성 함수
    function spawnBall(x, y, r, vx, vy, number, setId) {
      balls.push({
        x, y, r,
        vx, vy,
        number,
        setId
      });
      ballsInSet++;
    }

    // 세트(큰 공) 생성
    function spawnBallSet() {
      balls = [];
      ballsInSet = 0;
      ballsDestroyedInSet = 0;
      // setNumber가 올라갈수록 공의 내구도 증가
      const baseNumber = 2 + Math.floor(setNumber/2);
      // 큰 공 1개만 생성
      const angle = Math.PI/4 + Math.random() * Math.PI/2;
      const speed = 4 + Math.random()*2;
      const vx = Math.cos(angle) * speed * (Math.random()<0.5?-1:1);
      const vy = -Math.abs(Math.sin(angle) * speed) - 4;
      const r = BALL_MAX_RADIUS;
      const number = baseNumber + Math.floor(Math.random()*2); // setNumber 반영
      spawnBall(80 + Math.random()*320, 100, r, vx, vy, number, setNumber);
      lastBallTime = performance.now();
    }

    // 키 입력 처리
    document.addEventListener('keydown', e => keys[e.code] = true);
    document.addEventListener('keyup', e => keys[e.code] = false);

    // 여러 줄 총알 발사
    function autoShoot(now) {
      if (gameOver) return;
      if (now - lastBulletTime > BULLET_INTERVAL) {
        // bulletRows에 따라 여러 각도로 발사
        let angles = [];
        if (bulletRows === 1) {
          angles = [0];
        } else if (bulletRows === 2) {
          angles = [-Math.PI/12, Math.PI/12]; // 약 ±15도
        } else {
          // bulletRows개로 -30~+30도 균등 분포
          for (let i = 0; i < bulletRows; i++) {
            angles.push(-Math.PI/6 + (Math.PI/3)*(i/(bulletRows-1)));
          }
        }
        angles.forEach(angle => {
          const speed = 20;
          const vx = Math.sin(angle) * speed;
          const vy = -Math.cos(angle) * speed;
          bullets.push({
            x: player.x + player.w/2 - 2,
            y: player.y,
            w: 4,
            h: 12,
            vx,
            vy
          });
        });
        lastBulletTime = now;
      }
    }

    // 게임 루프
    function update(now) {
      if (gameOver) return;

      // 플레이어 이동
      if (keys['ArrowLeft']) player.x -= player.speed;
      if (keys['ArrowRight']) player.x += player.speed;
      player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));

      // 총알 이동
      bullets.forEach(b => {
        b.x += b.vx || 0;
        b.y += b.vy || -20;
      });
      bullets = bullets.filter(b => b.y + b.h > 0 && b.x > -10 && b.x < canvas.width+10);

      // 공 이동 (중력, 반사)
      balls.forEach(ball => {
        ball.x += ball.vx;
        ball.y += ball.vy;
        ball.vy += GRAVITY;

        // 벽 반사
        if (ball.x - ball.r < 0) {
          ball.x = ball.r;
          ball.vx = Math.abs(ball.vx) * BOUNCE_LOSS;
        }
        if (ball.x + ball.r > canvas.width) {
          ball.x = canvas.width - ball.r;
          ball.vx = -Math.abs(ball.vx) * BOUNCE_LOSS;
        }
        // 바닥 반사 (완전탄성)
        if (ball.y + ball.r > canvas.height) {
          ball.y = canvas.height - ball.r;
          ball.vy = -Math.abs(ball.vy) * BOUNCE_LOSS;
        }
        // 천장 반사
        if (ball.y - ball.r < 0) {
          ball.y = ball.r;
          ball.vy = Math.abs(ball.vy) * BOUNCE_LOSS;
        }
      });

      // 충돌 체크 (총알-공)
      bullets.forEach((b, bi) => {
        balls.forEach((ball, i) => {
          const dx = (b.x + b.w/2) - ball.x;
          const dy = (b.y) - ball.y;
          if (Math.sqrt(dx*dx + dy*dy) < ball.r) {
            ball.number--;
            bullets.splice(bi, 1);
            if (ball.number <= 0) {
              // 공 분열
              if (ball.r > BALL_MIN_RADIUS) {
                const split = BALL_MIN_SPLIT + Math.floor(Math.random()*(BALL_MAX_SPLIT-BALL_MIN_SPLIT+1));
                for (let s = 0; s < split; s++) {
                  const angle = Math.PI/4 + s * (Math.PI/(split+1));
                  const speed = 3 + Math.random()*2;
                  const vx = Math.cos(angle) * speed * (Math.random()<0.5?-1:1);
                  const vy = -Math.abs(Math.sin(angle) * speed) - 3;
                  const newR = ball.r * 0.6;
                  // setNumber 반영해서 난이도 증가
                  const newNum = 1 + Math.floor(Math.random()*2) + Math.floor(setNumber/3);
                  spawnBall(ball.x, ball.y, newR, vx, vy, newNum, ball.setId);
                }
              }
              balls.splice(i, 1);
              ballsDestroyedInSet++;
              score++;
            }
          }
        });
      });

      // 플레이어-공 충돌 체크
      balls.forEach(ball => {
        // 플레이어와 원-사각형 충돌
        const closestX = Math.max(player.x, Math.min(ball.x, player.x + player.w));
        const closestY = Math.max(player.y, Math.min(ball.y, player.y + player.h));
        const dx = ball.x - closestX;
        const dy = ball.y - closestY;
        if (dx*dx + dy*dy < ball.r*ball.r) {
          gameOver = true;
          document.getElementById('restart').style.display = 'block';
        }
      });

      // 세트의 모든 공을 다 부쉈으면 bulletRows 증가, 다음 세트로
      if (ballsInSet > 0 && ballsDestroyedInSet >= ballsInSet && balls.length === 0) {
        bulletRows++;
        setNumber++;
        setTimeout(spawnBallSet, 1000); // 1초 후 다음 세트
        ballsInSet = 0;
        ballsDestroyedInSet = 0;
      }

      // 게임 시작 후, 공이 없고, 세트가 끝난 상태가 아니면(즉, 첫 시작)
      if (balls.length === 0 && ballsInSet === 0 && now - lastBallTime > BALL_SPAWN_INTERVAL) {
        spawnBallSet();
      }

      // 총알 자동 발사
      autoShoot(now);
    }

    function draw() {
      // 배경
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 플레이어
      ctx.fillStyle = '#1976d2';
      ctx.fillRect(player.x, player.y, player.w, player.h);
      // 머리
      ctx.beginPath();
      ctx.arc(player.x + player.w/2, player.y - 10, 10, 0, Math.PI*2);
      ctx.fillStyle = '#fbc02d';
      ctx.fill();

      // 총알
      ctx.fillStyle = '#d32f2f';
      bullets.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));

      // 공
      balls.forEach(ball => {
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
        ctx.fillStyle = '#4caf50';
        ctx.fill();
        ctx.strokeStyle = '#222';
        ctx.stroke();
        // 숫자
        ctx.fillStyle = '#fff';
        ctx.font = `bold ${Math.floor(ball.r)}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(ball.number, ball.x, ball.y);
      });

      // 점수, 세트, 총알줄
      ctx.fillStyle = '#222';
      ctx.font = '20px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('점수: ' + score, 10, 30);
      ctx.fillText('세트: ' + setNumber, 10, 55);
      ctx.fillText('총알줄: ' + bulletRows, 10, 80);

      // 게임 오버
      if (gameOver) {
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = '40px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('게임 오버', canvas.width/2, canvas.height/2 - 20);
        ctx.font = '24px sans-serif';
        ctx.fillText('점수: ' + score, canvas.width/2, canvas.height/2 + 20);
      }
    }

    function loop(now) {
      update(now || 0);
      draw();
      requestAnimationFrame(loop);
    }

    // 게임 리셋
    function restartGame() {
      bullets = [];
      score = 0;
      gameOver = false;
      player.x = 240;
      document.getElementById('restart').style.display = 'none';
      setNumber = 1;
      bulletRows = 1;
      balls = [];
      ballsInSet = 0;
      ballsDestroyedInSet = 0;
      lastBallTime = performance.now();
    }

    window.restartGame = restartGame;

    // 시작
    balls = [];
    ballsInSet = 0;
    ballsDestroyedInSet = 0;
    setNumber = 1;
    bulletRows = 1;
    lastBallTime = performance.now();
    loop();
  </script>
</body>
</html>
